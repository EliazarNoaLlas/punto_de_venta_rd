name: Deploy POS Production

on:
  push:
    branches: [main, master]
  workflow_dispatch:  # Permite ejecuciÃ³n manual desde GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ” Configurar SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}
          ssh-known-hosts: ${{ secrets.VPS_SSH_KNOWN_HOSTS }}
      
      - name: ğŸš€ Ejecutar deploy en VPS
        run: |
          echo "Conectando al VPS y ejecutando deploy..."
          ssh -o StrictHostKeyChecking=no deploy@${{ secrets.VPS_HOST }} "
            cd /var/www/punto_de_venta_2025 &&
            bash deploy.sh
          "
      
      - name: âœ… Verificar deploy
        run: |
          ssh -o StrictHostKeyChecking=no deploy@${{ secrets.VPS_HOST }} "
            cd /var/www/punto_de_venta_2025 &&
            if [ -L current ] && [ -e current ]; then
              echo 'âœ… Symlink current vÃ¡lido'
              ls -la current | head -5
            else
              echo 'âŒ Error: symlink current no vÃ¡lido'
              exit 1
            fi &&
            pm2 status punto-venta-2025 || echo 'âš ï¸ PM2 no estÃ¡ corriendo'
          "

